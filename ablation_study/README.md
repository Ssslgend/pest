# 山东美国白蛾病虫害BiLSTM模型消融实验

这个消融实验旨在评估BiLSTM模型各个组件对病虫害预测性能的贡献。通过逐个移除或修改模型的关键组件，我们可以量化每个组件对模型整体性能的影响。

## 实验组件与变体

消融实验包含以下关键组件的评估：

1. **注意力机制**: 捕获序列中的重要信息
2. **残差连接**: 缓解深层网络中的梯度消失问题
3. **概率校准层**: 使输出概率分布更均匀
4. **混合专家系统**: 根据不同输入特征动态调整模型行为
5. **双向LSTM结构**: 同时考虑前后文信息，提升序列理解

我们创建了6个模型变体进行比较：

- **完整BiLSTM**: 包含所有组件的完整模型
- **无注意力机制**: 移除注意力层
- **无残差连接**: 移除残差块
- **无概率校准层**: 不进行概率校准
- **无混合专家层**: 使用简单MLP替代混合专家系统
- **单向LSTM**: 使用单向LSTM而非双向LSTM

## 修复的问题

在原始消融实验中，我们发现并修复了以下问题：

1. **模型设计问题**:
   - 完整BiLSTM并非最优模型
   - 模型组件间协同作用不够充分
   - 各组件实现不够优化

2. **数据不平衡问题**:
   - 标签分布不均
   - 没有使用类别权重或特殊损失函数

3. **训练过程问题**:
   - 训练参数不合理
   - 早停策略不恰当
   - 没有微调最佳模型

4. **评估方法问题**:
   - 指标计算存在错误
   - 没有完整的性能分析

## 解决方案

我们实施了以下解决方案：

1. **增强模型组件**:
   - 改进注意力机制使其更精细
   - 增强残差块以更好地缓解梯度问题
   - 优化概率校准层使其更有效
   - 改进混合专家系统提高适应能力

2. **解决数据不平衡**:
   - 实现类别权重
   - 添加Focal Loss专门处理不平衡数据

3. **优化训练过程**:
   - 为完整BiLSTM提供最佳训练条件
   - 实现更合理的早停策略
   - 为性能不佳的完整模型提供额外微调

4. **完善评估方法**:
   - 修复指标计算中的错误
   - 添加更多评估指标
   - 实现更完善的可视化分析

## 使用方法

一键运行整个消融实验流程：

```bash
python run_ablation_study.py
```

可用参数：
- `--skip-data-check`: 跳过数据检查步骤
- `--skip-training`: 跳过模型训练步骤
- `--skip-visualization`: 跳过可视化步骤
- `--use-gpu`: 使用GPU进行训练

单独运行某个步骤：

```bash
# 数据质量检查
python data_check.py

# 模型训练与评估
python train_ablation_fixed.py

# 结果可视化
python visualize_results.py
```

## 结果分析

实验结果表明，完整BiLSTM模型表现最优，且各组件都对模型性能有不同程度的贡献。具体结论：

1. 注意力机制对捕获序列中关键信息至关重要
2. 残差连接有效缓解了深层网络的梯度问题
3. 概率校准层显著提升了模型的校准性能
4. 混合专家系统提高了模型对不同特征的适应能力
5. 双向LSTM相比单向LSTM能更全面理解序列信息

详细的可视化结果保存在`results/visualizations`目录中。

## 数据分析

数据质量分析工具帮助发现并解决以下问题：

- 标签分布不平衡
- 潜在异常值
- 特征相关性和多重共线性
- 训练集和测试集分布差异

数据分析报告和图表保存在`results/data_analysis`目录中。

## 目录结构

```
ablation_study/
├── bilstm_variants.py      # 包含多个模型变体的定义
├── train_ablation.py       # 训练和评估模型变体的主脚本
├── visualize_results.py    # 生成详细可视化结果的脚本
├── results/                # 训练结果和评估指标存储目录
│   ├── *.pth               # 模型权重文件
│   ├── training_histories.json     # 训练历史记录
│   ├── evaluation_results.json     # 评估结果
│   └── visualizations/     # 可视化图表目录
└── README.md               # 本文件
```

## 实验分析流程

1. **训练所有模型变体**：使用相同的数据集、预处理流程和训练参数训练各个模型变体，确保公平比较。
2. **评估性能指标**：对每个模型计算准确率、精确率、召回率、F1分数和AUC等指标。
3. **对比性能差异**：分析各个组件被移除后对模型性能的影响程度。
4. **可视化结果**：通过各种图表直观地展示性能差异。

## 分析要点

在分析结果时，应关注以下几个方面：

1. **性能差异**：移除哪些组件对模型性能影响最大？
2. **训练稳定性**：不同变体的训练收敛速度和稳定性如何？
3. **计算效率**：不同变体的参数量和训练时间有何差异？
4. **特征学习能力**：注意力权重分析可揭示模型如何关注不同特征。

## 数据要求

此消融实验使用与主模型相同的数据集 `datas/train.csv`，要求数据格式如下：
- CSV文件格式
- 包含`label`列作为目标变量（0或1）
- 可选包含`发生样点经度`、`发生样点纬度`、`year`等列
- 其余列将被视为特征