# 空间平滑处理在害虫风险预测中的应用

## 问题背景

在使用BiLSTM模型进行害虫风险预测时，我们遇到了以下问题：

1. **风险分布不自然**：预测结果在空间上呈现离散点状分布，而非生态学中常见的连续区域
2. **类别分布偏倚**：初始预测中，98%的像素被分类为中风险类别（已通过分位数法解决）
3. **概率值集中**：预测概率集中在较窄范围内(0.5-0.73)，缺乏足够的差异性

为解决这些问题，特别是空间分布离散的问题，我们引入了空间平滑处理技术。

## 空间平滑处理原理

空间平滑处理利用地理学第一定律（Tobler's First Law of Geography）："所有的地点都是相关的，但是近的地点比远的地点更相关"。这一原理在生态学领域尤为适用，因为：

1. 自然环境因素（气候、土壤、地形等）通常呈连续变化
2. 生物种群的扩散也遵循空间连续性规律
3. 相邻区域的生态特征往往更为相似

空间平滑技术通过考虑像素周围邻域的值，重新计算每个像素的值，从而减少异常值的影响并增强空间连续性。

## 实现的平滑方法

我们实现了四种空间平滑方法：

### 1. 高斯平滑 (Gaussian Smoothing)

- **原理**：使用二维高斯函数作为权重核，对图像进行加权平均
- **特点**：保持连续过渡，减少噪声，对连续数据（如概率值）效果最佳
- **参数**：sigma值控制平滑强度，值越大平滑效果越强

### 2. 中值平滑 (Median Filtering)

- **原理**：用像素邻域的中值替代该像素的值
- **特点**：有效消除离群点，同时保持边界锐利，适合分类数据（如风险等级）
- **参数**：窗口大小决定考虑的邻域范围

### 3. 均值平滑 (Mean Filtering)

- **原理**：简单地计算邻域内所有像素的平均值
- **特点**：效果介于高斯和中值之间，计算简单
- **参数**：窗口大小

### 4. 自适应局部平滑 (Adaptive Local Smoothing)

- **原理**：根据局部区域特性动态调整平滑强度
- **特点**：在高方差区域减弱平滑以保留细节，在低方差区域增强平滑以去除噪声
- **参数**：基础平滑方法和参数

## 使用方法

1. **运行空间平滑处理**：
   ```
   python run_smooth.py
   ```
   此脚本会对概率栅格和风险等级栅格分别应用适当的平滑方法。

2. **查看平滑效果对比**：
   ```
   python run_smoothed_visualize.py
   ```
   此脚本生成多种可视化图形，包括平滑前后的直接对比、差异图和分布直方图。

3. **一键执行全流程**：
   ```
   python run_all_with_smoothing.py
   ```
   此脚本会自动执行预测、平滑、对比可视化和结果可视化的完整流程。

## 平滑效果分析

空间平滑处理后，风险预测结果呈现以下改进：

1. **空间连续性提升**：高风险区域从离散点状分布转变为连续区域，更符合生态学原理
2. **减少噪声和孤立点**：消除了预测过程中产生的异常值和噪声
3. **保持总体分布特征**：平滑处理保留了原始预测的主要分布特征，同时改善了细节表现
4. **提高可解释性**：平滑后的结果更易于理解和应用于实际害虫风险管理决策

## 技术细节

### 权重处理

为了正确处理边界和NoData值，我们采用了权重归一化技术：

1. 对NoData区域应用掩码，仅对有效数据进行平滑
2. 计算每个像素的平滑权重贡献
3. 通过权重归一化避免边界效应和NoData值的影响

### 参数选择

- 高斯平滑：默认sigma=2.0，提供适度的平滑效果
- 中值平滑：默认窗口大小=5，适合去除小范围噪声
- 自适应平滑：基于局部方差动态调整参数

## 注意事项

1. 平滑处理可能会稍微降低局部预测精度，但通常会提高整体的生态学合理性
2. 不同问题可能需要调整平滑参数以获得最佳效果
3. 概率数据推荐使用高斯平滑，分类数据推荐使用中值平滑

## 参考文献

1. Tobler, W. R. (1970). A computer movie simulating urban growth in the Detroit region. *Economic Geography*, 46(sup1), 234-240.
2. Wu, J., & Marceau, D. (2002). Modeling complex ecological systems: an introduction. *Ecological Modelling*, 153(1-2), 1-6.
3. Gonzalez, R. C., & Woods, R. E. (2018). *Digital image processing* (4th ed.). Pearson. 